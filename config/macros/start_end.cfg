# DO NOT EDIT THIS FILE.
# This file is part of a git repository, your changes may prevent updates

[gcode_macro PRINT_START]
gcode:
    SET_FAN_SPEED FAN=board_fan SPEED=0.5
    # Load Z offset, cancel if none is set
    {% set gcode_offset = printer.gcode_move.homing_origin.z|float %}
    {% set auto_z_offset = printer.configfile.config.auto_z_offset.calibrated_z_offset|float %}
    {% if gcode_offset == 0.0 %}
        AUTO_Z_LOAD_OFFSET
        {% if auto_z_offset == 0.0 %}
            _ERROR MSG="No gcode offset detected! Run AUTO_Z_CALIBRATE before starting a print to ensure a good first layer."
        {% endif %}
    {% endif %}

    {% set bedtemp = params.BED|int %}
    {% set hotendtemp = params.HOTEND|int %}
    {% set chambertemp = params.CHAMBER|default(0)|int %}
    M140 S{bedtemp}
    M141 S{chambertemp}
    M104 S{hotendtemp * 0.7}
    G28

    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bedtemp * 0.95} MAXIMUM={bedtemp * 1.05}
    BED_MESH_CALIBRATE PROFILE=adaptive ADAPTIVE=1
    M191 S{chambertemp}
    CLEAR_NOZZLE HOTEND={hotendtemp} COOLDOWN=0
    M109 S{hotendtemp}

    ENABLE_FILAMENT_SENSORS

[gcode_macro PRINT_END]
gcode:
    CLEAR_PAUSE

    DISABLE_FANS_AND_HEATERS

    M220 S100 #reset speed factor
    M221 S100 #reset extrude factor

    M84

    DISABLE_FILAMENT_SENSORS
    SET_GCODE_OFFSET Z=0 MOVE=0
    BED_MESH_CLEAR
    CLEAR_LAST_FILE
    BEEP I=2 DUR=500
