# DO NOT EDIT THIS FILE.
# This file is part of a git repository, your changes may prevent updates

[gcode_macro GO_TO_BUCKET]
description: Go to purge bucket position for filament unload or purging
gcode:
    SAVE_VARIABLE VARIABLE=at_bucket VALUE=True
    _CLEAR_Z AMOUNT=30

    G90 ; absolute

    {% set curr_y = printer.toolhead.position.y %}
    {% if curr_y > 240 %} ; prevent crash from rear
        G1 Y240 F9000
    {% endif %}

    G1 X97 Y240 F9000
    _SET_ACCEL ACCEL=100
    G1 Y254 F1500 ; gently press against wiper arm
    _SET_ACCEL ; reset accel

[gcode_macro LEAVE_BUCKET]
description: Leave the bucket gracefully
gcode:
    SAVE_VARIABLE VARIABLE=at_bucket VALUE=False
    {% set curr_x = printer.toolhead.position.x %}
    {% set curr_y = printer.toolhead.position.y %}
    {% if (curr_y >= 240) and (curr_x >= 59) and (curr_x <= 98) %}
        G90 ; absolute
        _SET_ACCEL ACCEL=500
        G1 Y254 F2000
        G1 X70 F5000
        _SET_ACCEL ACCEL=100
        G1 Y240 F1500 ; gently leave the wiper arm
        _SET_ACCEL ; reset accel
    {% endif %}

[gcode_macro _BUCKET_CUT]
description: Cut off the extruded filament on the nozzle
gcode:
    {% set i = 6 %}
    {% for iteration in range(i|int) %}
        G1 X85 F2000
        G1 X97 F2000
    {% endfor %}

[gcode_macro _FELT_WIPE]
description: Wipe on the felt pad
gcode:
    G90 ; absolute
    ; felt is roughly X60-88 (88 is the "cutter" end), Y254-250

    {% set random_x = (range(0, 100) | random) / 10 %}
    {% set X_end = 60 + random_x %}

    {% set random_y = (range(0, 40) | random) / 10 %}
    {% set Y_end = 254 - random_y %}
    G1 Y{Y_end} F1500

    {% set i = 3 %}
    {% for iteration in range(i|int) %}
        G1 X88 F500
        G1 X{X_end} F500
    {% endfor %}

    {% for iteration in range(i|int) %}
        G1 Y249 F500
        G1 Y{Y_end} F500
    {% endfor %}

    {% for iteration in range(i|int) %}
        G1 X88 F500
        G1 X{X_end} F500
    {% endfor %}


[gcode_macro _BUCKET_PURGE]
description: Purge filament to the purge bucket
gcode:
    M118 Purging

    {% set hotendtemp = params.HOTEND|default(250)|int %}
    M104 S{hotendtemp}

    GO_TO_BUCKET

    ; Wait for extruder to be +/- 5% of target
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={hotendtemp * 0.95} MAXIMUM={hotendtemp * 1.05}

    {% set purgeamount = params.AMOUNT|default(80)|int %}
    M83 ; relative E
    G92 E0 ; reset E
    G1 E{purgeamount} F400 ; extrude
    G1 E-1 F400 ; retract

    M106 S255 ; cooling fan max
    G4 P5000 ; wait for 5 seconds
    M106 S0 ; cooling fan off

    _BUCKET_CUT
    {% set leave = params.LEAVE|default(1)|int %}
    {% if leave > 0 %}
        LEAVE_BUCKET
    {% endif %}


[gcode_macro CLEAR_NOZZLE]
gcode:
    {% set hotendtemp = params.HOTEND|default(250)|int %}
    {% set purgeamount = params.AMOUNT|default(80)|int %}
    {% set cool_nozzle = params.COOLDOWN|default(1)|int %}

    _BUCKET_PURGE HOTEND={hotendtemp} AMOUNT={purgeamount} LEAVE={0} ; purge without leaving

    {% if cool_nozzle > 0 %}
        M104 S0 ; shut down extruder
    {% endif %}
    _FELT_WIPE
    M400
    M118 Nozzle cleared

    LEAVE_BUCKET ; gracefully leave the bucket

    {% if cool_nozzle > 0 %}
        G1 Y120 F9000
        G1 X230 F9000
        SET_FAN_SPEED FAN=auxiliary_cooling_fan SPEED=1
        SET_FAN_SPEED FAN=cooling_fan SPEED=1
        TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={hotendtemp * 0.8}
        M118 Nozzle cooled
        SET_FAN_SPEED FAN=auxiliary_cooling_fan SPEED=0
        SET_FAN_SPEED FAN=cooling_fan SPEED=0
    {% endif %}

    M107
    M106 P2 S0
    M400


